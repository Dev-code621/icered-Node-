FROM node:13

LABEL name=signaling-svc \
      version=1.0.1 \
      maintainer="Devontrae Walls <vont@centauri.co.com>"

ARG NODE_ENV=production
ARG MONGO_HOST=
ARG MONGO_DBNAME=
ARG MONGO_PORT=27017
ARG MONGO_USER=
ARG MONGO_PASS=
ARG MONGO_SRV=
ARG TWILIO_ACCOUNT_SID=
ARG TWILIO_AUTH_TOKEN=
ARG JWT_SECRET=
ARG AWS_ID=
ARG AWS_SECRET=
ARG AWS_BUCKET_NAME=
ARG CLIENT_JWT=
ARG ALGOLIA_CLIENT=
ARG ALGOLIA_SECRET=
ARG SENDGRID_API_KEY=
ARG AWS_VIDEO_BUCKET=
ARG VERSION=

ENV NODE_ENV=$NODE_ENV
ENV MONGO_HOST=$MONGO_HOST
ENV MONGO_DBNAME=$MONGO_DBNAME
ENV MONGO_PORT=$MONGO_PORT
ENV MONGO_USER=$MONGO_USER
ENV MONGO_PASS=$MONGO_PASS
ENV MONGO_SRV=$MONGO_SRV
ENV TWILIO_ACCOUNT_SID=$TWILIO_ACCOUNT_SID
ENV TWILIO_AUTH_TOKEN=$TWILIO_AUTH_TOKEN
ENV JWT_SECRET=$JWT_SECRET
ENV AWS_ID=$AWS_ID
ENV AWS_SECRET=$AWS_SECRET
ENV AWS_BUCKET_NAME=$AWS_BUCKET_NAME
ENV CLIENT_JWT=$CLIENT_JWT
ENV ALGOLIA_CLIENT=$ALGOLIA_CLIENT
ENV ALGOLIA_SECRET=$ALGOLIA_SECRET
ENV SENDGRID_API_KEY=$SENDGRID_API_KEY
ENV AWS_VIDEO_BUCKET=$AWS_VIDEO_BUCKET
ENV VERSION=$VERSION

WORKDIR /usr/src/app

COPY . .

RUN npm install -g pm2
RUN npm install
# RUN sed -i 's/pidusage(pids, function retPidUsage(err, statistics) {/pidusage(pids, { usePs: true }, function retPidUsage(err, statistics) {/' {/usr/src/app/node_modules/pm2/lib/God/ActionMethods.js

EXPOSE 8340
EXPOSE 8342
EXPOSE 4000

CMD ["pm2-runtime", "server.js"]
